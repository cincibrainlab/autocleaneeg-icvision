# Kamal 2.8+ deployment configuration for ICVision Rater
# Requires: kamal-proxy v0.9.0+, Docker with container driver
# Secrets: OP_SERVICE_ACCOUNT_TOKEN must be set for 1Password integration
service: rater

# Container image name
image: cincibrainlab/icvision-rater

# Deploy to hel2 server
servers:
  web:
    - hel2
  # job:
  #   hosts:
  #     - hel2
  #   cmd: bin/jobs

# Proxy configuration (kamal-proxy on port 8080 for tunnel)
proxy:
  host: icrater.cincibrainlab.com
  # SSL handled by tunnel, not kamal-proxy
  ssl: false
  healthcheck:
    path: /up
    interval: 3
    timeout: 3
  run:
    http_port: 8080

# Container registry (GitHub Container Registry)
registry:
  server: ghcr.io
  username: cincibrainlab
  password:
    - KAMAL_REGISTRY_PASSWORD

# Environment variables (secrets from .kamal/secrets)
env:
  secret:
    - RAILS_MASTER_KEY
    - POSTGRES_PASSWORD
  clear:
    # Solid Queue in Puma process (split to dedicated server when scaling)
    SOLID_QUEUE_IN_PUMA: true
    # PostgreSQL connection via Docker network
    DB_HOST: rater-postgres
    POSTGRES_USER: rater
    POSTGRES_DB: rater_production
    # WEB_CONCURRENCY: 2
    # RAILS_LOG_LEVEL: debug

# Deployment timeouts (new in Kamal 2.x)
deploy_timeout: 30
drain_timeout: 10
readiness_delay: 3

# Useful aliases
aliases:
  console: app exec --interactive --reuse "bin/rails console"
  shell: app exec --interactive --reuse "bash"
  logs: app logs -f
  dbc: app exec --interactive --reuse "bin/rails dbconsole --include-password"

# Asset bridging for zero-downtime deploys
asset_path: /rails/public/assets

# Image builder configuration
builder:
  arch: amd64
  # For arm64 Mac building amd64 images:
  # remote: ssh://docker@docker-builder-server
  # args:
  #   RUBY_VERSION: 3.4.7

# SSH configuration
# ssh:
#   user: app

# PostgreSQL accessory
accessories:
  postgres:
    image: postgres:17
    host: hel2
    port: "127.0.0.1:5432:5432"
    env:
      clear:
        POSTGRES_USER: rater
        POSTGRES_DB: rater_production
      secret:
        - POSTGRES_PASSWORD
    directories:
      - data:/var/lib/postgresql/data
