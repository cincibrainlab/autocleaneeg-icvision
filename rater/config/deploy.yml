# Kamal 2.8+ deployment configuration for ICVision Rater
# Requires: kamal-proxy v0.9.0+, Docker with container driver
service: rater

# Container image name (use registry/user/app-name for external registries)
image: rater

# Deploy to these servers
servers:
  web:
    - 192.168.0.1
  # job:
  #   hosts:
  #     - 192.168.0.1
  #   cmd: bin/jobs

# Proxy configuration (kamal-proxy replaces Traefik in Kamal 2.x)
# Thruster runs on port 80, matching kamal-proxy default
proxy:
  # SSL via Let's Encrypt (uncomment for production with real domain)
  # ssl: true
  # host: rater.example.com
  healthcheck:
    path: /up
    interval: 3
    timeout: 3

# Container registry (Kamal 2.8+ supports local registry for faster deploys)
registry:
  server: localhost:5555
  # For external registries:
  # server: ghcr.io
  # username: your-user
  # password:
  #   - KAMAL_REGISTRY_PASSWORD

# Environment variables (secrets from .kamal/secrets)
env:
  secret:
    - RAILS_MASTER_KEY
    - POSTGRES_PASSWORD
  clear:
    # Solid Queue in Puma process (split to dedicated server when scaling)
    SOLID_QUEUE_IN_PUMA: true
    # PostgreSQL connection via Docker network
    DB_HOST: rater-postgres
    POSTGRES_USER: rater
    POSTGRES_DB: rater_production
    # WEB_CONCURRENCY: 2
    # RAILS_LOG_LEVEL: debug

# Deployment timeouts (new in Kamal 2.x)
deploy_timeout: 30
drain_timeout: 10
readiness_delay: 3

# Useful aliases
aliases:
  console: app exec --interactive --reuse "bin/rails console"
  shell: app exec --interactive --reuse "bash"
  logs: app logs -f
  dbc: app exec --interactive --reuse "bin/rails dbconsole --include-password"

# Asset bridging for zero-downtime deploys
asset_path: /rails/public/assets

# Image builder configuration
builder:
  arch: amd64
  # For arm64 Mac building amd64 images:
  # remote: ssh://docker@docker-builder-server
  # args:
  #   RUBY_VERSION: 3.4.7

# SSH configuration
# ssh:
#   user: app

# PostgreSQL accessory
accessories:
  postgres:
    image: postgres:17
    host: 192.168.0.1
    port: "127.0.0.1:5432:5432"
    env:
      clear:
        POSTGRES_USER: rater
        POSTGRES_DB: rater_production
      secret:
        - POSTGRES_PASSWORD
    directories:
      - data:/var/lib/postgresql/data
